<% contentFor('body') %>
<div class="course-lessons-container teacher-container">
  <div class="course-breadcrumbs">
    <a href="/courses/my">–ú–æ–∏ –∫—É—Ä—Å—ã</a> / 
    <a href="/courses/my/<%= course.id %>"><%= course.title %></a> / 
    <span>–£—Ä–æ–∫–∏</span>
  </div>
  
  <h1 class="page-title">–£–ø—Ä–∞–≤–ª–µ–Ω–∏–µ —É—Ä–æ–∫–∞–º–∏ –∫—É—Ä—Å–∞ "<%= course.title %>"</h1>
  
  <div class="lessons-actions">
    <a href="/courses/my/<%= course.id %>/lessons/create" class="button-blue">+ –î–æ–±–∞–≤–∏—Ç—å –Ω–æ–≤—ã–π —É—Ä–æ–∫</a>
  </div>
  
  <div class="lessons-list-container">
    <% if (course.lessons && course.lessons.length > 0) { %>
      <div class="lessons-list">
        <div class="lesson-row header">
          <div class="lesson-cell">‚Ññ</div>
          <div class="lesson-cell">–ù–∞–∑–≤–∞–Ω–∏–µ</div>
          <div class="lesson-cell">–ü—Ä–æ–¥–æ–ª–∂–∏—Ç–µ–ª—å–Ω–æ—Å—Ç—å</div>
          <div class="lesson-cell">–î–µ–π—Å—Ç–≤–∏—è</div>
        </div>
        
        <% course.lessons.forEach((lesson, index) => { %>
          <div class="lesson-row" data-id="<%= lesson.id %>">
            <div class="lesson-cell"><%= lesson.order || index + 1 %></div>
            <a class="lesson-cell lesson-title" href="/lessons/<%=lesson.id%>"><%= lesson.title %></a>
            <div class="lesson-cell"><%= lesson.duration ? `${lesson.duration} –º–∏–Ω.` : '–ù–µ —É–∫–∞–∑–∞–Ω–æ' %></div>
            <div class="lesson-cell actions">
              <a href="/lessons/<%= lesson.id %>/edit" class="lesson-action edit" title="–†–µ–¥–∞–∫—Ç–∏—Ä–æ–≤–∞—Ç—å">‚úèÔ∏è</a>
              <button class="lesson-action delete" data-id="<%= lesson.id %>" title="–£–¥–∞–ª–∏—Ç—å">üóëÔ∏è</button>
            </div>
          </div>
        <% }); %>
      </div>
    <% } else { %>
      <div class="empty-state">
        <div class="empty-icon">üìù</div>
        <h3>–í —ç—Ç–æ–º –∫—É—Ä—Å–µ –ø–æ–∫–∞ –Ω–µ—Ç —É—Ä–æ–∫–æ–≤</h3>
        <p>–î–æ–±–∞–≤—å—Ç–µ –ø–µ—Ä–≤—ã–π —É—Ä–æ–∫, —á—Ç–æ–±—ã –Ω–∞—á–∞—Ç—å —Å–æ–∑–¥–∞–Ω–∏–µ –∫–æ–Ω—Ç–µ–Ω—Ç–∞</p>
        <a href="/courses/my/<%= course.id %>/lessons/create" class="button-blue">+ –î–æ–±–∞–≤–∏—Ç—å —É—Ä–æ–∫</a>
      </div>
    <% } %>
  </div>
  
  <!-- –ú–æ–¥–∞–ª—å–Ω–æ–µ –æ–∫–Ω–æ –ø–æ–¥—Ç–≤–µ—Ä–∂–¥–µ–Ω–∏—è —É–¥–∞–ª–µ–Ω–∏—è -->
  <div class="modal" id="delete-lesson-modal">
    <div class="modal-content">
      <span class="close">&times;</span>
      <h2>–ü–æ–¥—Ç–≤–µ—Ä–∂–¥–µ–Ω–∏–µ —É–¥–∞–ª–µ–Ω–∏—è</h2>
      <p>–í—ã —É–≤–µ—Ä–µ–Ω—ã, —á—Ç–æ —Ö–æ—Ç–∏—Ç–µ —É–¥–∞–ª–∏—Ç—å —ç—Ç–æ—Ç —É—Ä–æ–∫? –≠—Ç–æ –¥–µ–π—Å—Ç–≤–∏–µ –Ω–µ–ª—å–∑—è –æ—Ç–º–µ–Ω–∏—Ç—å.</p>
      <div class="modal-footer">
        <button class="button-red" id="confirm-delete">–£–¥–∞–ª–∏—Ç—å</button>
        <button class="button-grey cancel">–û—Ç–º–µ–Ω–∞</button>
      </div>
    </div>
  </div>
</div>

<% contentFor('style') %>
<link rel="stylesheet" href="/css/my-courses.css">

<% contentFor('script') %>
<script>
  document.addEventListener('DOMContentLoaded', function() {
    let lessonToDelete = null;
    const deleteModal = document.getElementById('delete-lesson-modal');
    
    // –î–µ–ª–µ–≥–∏—Ä–æ–≤–∞–Ω–∏–µ —Å–æ–±—ã—Ç–∏–π –¥–ª—è –∫–Ω–æ–ø–æ–∫ —É–¥–∞–ª–µ–Ω–∏—è
    document.querySelectorAll('.lesson-action.delete').forEach(button => {
      button.addEventListener('click', function() {
        lessonToDelete = this.getAttribute('data-id');
        if (deleteModal) {
          deleteModal.style.display = 'block';
        }
      });
    });
    
    // –ó–∞–∫—Ä—ã—Ç–∏–µ –º–æ–¥–∞–ª—å–Ω–æ–≥–æ –æ–∫–Ω–∞
    if (deleteModal) {
      deleteModal.querySelector('.close').addEventListener('click', () => {
        deleteModal.style.display = 'none';
      });
      
      deleteModal.querySelector('.cancel').addEventListener('click', () => {
        deleteModal.style.display = 'none';
      });
      
      // –ü–æ–¥—Ç–≤–µ—Ä–∂–¥–µ–Ω–∏–µ —É–¥–∞–ª–µ–Ω–∏—è
      deleteModal.querySelector('#confirm-delete').addEventListener('click', async () => {
        if (!lessonToDelete) return;
        
        try {
          const response = await fetch(`/lessons/api/${lessonToDelete}`, {
            method: 'DELETE',
            credentials: 'include'
          });
          
          if (response.ok) {
            // –£–¥–∞–ª—è–µ–º —Å—Ç—Ä–æ–∫—É —É—Ä–æ–∫–∞ –∏–∑ DOM
            const lessonRow = document.querySelector(`.lesson-row[data-id="${lessonToDelete}"]`);
            if (lessonRow) {
              lessonRow.style.opacity = '0';
              setTimeout(() => {
                lessonRow.remove();
                
                // –ü—Ä–æ–≤–µ—Ä—è–µ–º, –æ—Å—Ç–∞–ª–∏—Å—å –ª–∏ —É—Ä–æ–∫–∏
                const lessonRows = document.querySelectorAll('.lesson-row:not(.header)');
                if (lessonRows.length === 0) {
                  document.querySelector('.lessons-list-container').innerHTML = `
                    <div class="empty-state">
                      <div class="empty-icon">üìù</div>
                      <h3>–í —ç—Ç–æ–º –∫—É—Ä—Å–µ –ø–æ–∫–∞ –Ω–µ—Ç —É—Ä–æ–∫–æ–≤</h3>
                      <p>–î–æ–±–∞–≤—å—Ç–µ –ø–µ—Ä–≤—ã–π —É—Ä–æ–∫, —á—Ç–æ–±—ã –Ω–∞—á–∞—Ç—å —Å–æ–∑–¥–∞–Ω–∏–µ –∫–æ–Ω—Ç–µ–Ω—Ç–∞</p>
                      <a href="/courses/my/<%= course.id %>/lessons/create" class="button-blue">+ –î–æ–±–∞–≤–∏—Ç—å —É—Ä–æ–∫</a>
                    </div>
                  `;
                }
              }, 300);
            }
            
            // –ó–∞–∫—Ä—ã–≤–∞–µ–º –º–æ–¥–∞–ª—å–Ω–æ–µ –æ–∫–Ω–æ
            deleteModal.style.display = 'none';
          } else {
            throw new Error('–ù–µ —É–¥–∞–ª–æ—Å—å —É–¥–∞–ª–∏—Ç—å —É—Ä–æ–∫');
          }
        } catch (error) {
          console.error('Error:', error);
          alert(error.message);
          deleteModal.style.display = 'none';
        }
      });
    }
  });
</script>
